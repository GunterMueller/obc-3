#!/bin/sh
# test/regress.  Generated from regress.in by configure.

#
# Oxford Oberon-2 compiler
# test/regress.in
# Copyright (C) J. M. Spivey 1995--2016
#

srcdir=../test
lib=../lib
LIBDIR=/usr/arm-linux-gnueabihf/lib
compiler="../compiler/obc1 -I $lib"
interp="env OBC_LIB=. qemu-arm -B 0x100000 $LIBDIR/ld-linux.so.3 \
    --library-path $LIBDIR ./obxj-arm"

status=0

$compiler -x $srcdir/xTypes.m >xTypes.k
$compiler -07 $srcdir/xTypes07.m >xTypes07.k
$compiler -x $srcdir/xPrelude.m >xPrelude.k

for f in ${*:-`cd $srcdir; echo t*.m`}; do
    echo "$f"

    case $f in
        tMixIt.m) flag='-w -x';;
        *07.m) flag='-07 -x';;
        *) flag=-x ;;
    esac

    rm -f a.out a.k out code
    ($compiler $flag -O $srcdir/$f >a.k \
	&& sed -f $srcdir/stamp.sed a.k >code \
	&& ../runtime/oblink -L $lib \
                             xTypes.k xTypes07.k xPrelude.k a.k -o a.out \
	&& if $run; then \
	    $interp ./a.out dummy arguments >out 2>&1; fi)
    sed -n -e '1,/^(\*<</d' -e '/^>>\*)/q' -e p $srcdir/$f >out.0
    diff out.0 out || status=1
done

if [ $status -ne 0 ]; then echo Failed!; fi
exit $status
