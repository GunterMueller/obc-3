#!/bin/sh

# @configure_input@

#
# Oxford Oberon-2 compiler
# test/errtest.in
# Copyright (C) J. M. Spivey 1995, 1998
#

# Config stuff
srcdir=@srcdir@
top_srcdir=@top_srcdir@
DIFF=@DIFF@
WINDOWS=@WINDOWS@
# End of config

for d in ../lib $top_srcdir/lib; do
    if [ -r $d/lscript ]; then
	lib=$d; break
    fi
done
if [ -z "$lib" ]; then
    echo Couldn\'t find library files
    exit 2
fi

promote=false; code=true;
if [ "$1" = -promote ]; then promote=true; shift; fi

compiler="../compiler/obc1 -I $lib -O"

# Under MSYS/MinGW, the "sed -n p" converts CR/LF to LF in test output
if [ "$WINDOWS" = 1 ]; then
    fixup=dos2unix
    fixexp='sed -e s/\([0-9]\)E\([+-]\)\([0-9][0-9]\)$/\1E\20\3/'
else
    fixup=cat
    fixexp=cat
fi

cp -f $srcdir/SemError0.m SemError.m

set -x

$compiler $srcdir/SemDefs.m >SemDefs.k

$compiler SemError.m 2>msgs >/dev/null

if $promote; then
    cp -f msgs $srcdir/SemMsgs
else
    $fixup <msgs | $DIFF $srcdir/SemMsgs -
fi
